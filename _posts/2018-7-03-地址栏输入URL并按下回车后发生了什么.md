
---
layout:     post
date:       2018-07-03
author:     WWJ
header-img: img/post-bg-mma.jpg
catalog: true
tags: javascript
---

# 从地址栏输入URL并按下回车键之后发生了什么
### 浏览器识别URL
完整的URL包括以下几部分，其中
*  **协议**（eg: `http, https, ftp等`）
*  **域名**（eg: `www.google.com`）
*  **端口**（eg: `8080`）
*  **文件路径**（eg:  `/html_data/20180703/index.html`）
*  **参数**（eg: `?key=value&&key2=value2`）
*  **锚**点（eg: `#first-paragraph`）

如果输入的URL不符合正确的URL格式时，浏览器就会将输入的URL当作关键字来进行搜索，如果输入的URL符合正确的URL格式时，那么浏览器就会向服务器发送请求

### 浏览器向服务器发送请求
在请求之前，浏览器会做一下几件事：
1. **DNS解析**
将域名解析成与之对应的IP地址，首先浏览器会检查域名是否已经在本地缓存中，如果存在，则不需要DNS查询，如果不存在，浏览器就会将域名发送到根域名服务器，根域名服务器解析由浏览器发送过来的域名，解析成功后将IP地址返回给浏览器
2.  **建立连接**
有了IP地址以后，就可以选择TCP或UDP协议来发送数据了
3. **发送请求**
选择HTTP还是HTTPS发送请求，当下一个请求来到的时候，如果是相同的URL，缓存会根据缓存机制决定是直接使用副本响应访问请求，还是向源服务器再次发送请求。比较常见的就是浏览器会缓存访问过网站的网页，当再次访问这个URL地址的时候，如果网页没有更新，就不会再次下载网页，而是直接使用本地缓存的网页。只有当网站明确标识资源已经更新，浏览器才会再次下载网页。

### 服务器处理请求
服务器处理请求的过程大致如下
1.  接受请求
2. 服务器把请求拆分为一下几个参数：
* http方法（GET、POST、PUT、DELETE、CONNECT、OPTIONES），直接在地址栏中输入URL这种情况使用的是GET
* 域名：google.com
* 请求路径/页面：/

### 浏览器接收并处理响应
向服务器发出请求，并在浏览器窗口展示你所请求得网络资源，这里说的资源时html，也可以时图片或者PDF
 **浏览器主要组件**
* 用户界面
* 浏览器引擎：告知浏览器以哪种解析规则解析文档，因为每种浏览器用都有自己的内核，这也就是为什么每种浏览器的初始化样式都不一样的原因
* 呈现引擎：（UI层）
* 用户界面后端
* 网络
* 数据存储（cookies）

**呈现引擎**
主要在用户界面上呈现从服务器请求过来得资源，在呈现之前所走的流程有以下几步
1. 获取网络资源（一般为html文档）
2. 解析html文档，将标记逐个转化为DOM节点，同时解析css文件中的样式规则和样式元素中的元素数据，html中的带有视觉指令的样式信息用于构建另外一个树，呈现树
3. 呈现树包含多个带有视觉属性（如颜色和尺寸）的矩形。
4. 布局：也就是为每个节点分配一个应出现在屏幕上的确切坐标。
5.  绘制：呈现引擎会遍历呈现树，由用户界面后端层将每个节点绘制出来。

**解析过程**
1. 词法分析：将文档内容转化成标记，并将标记传递给语法分析器
2. 语法分析：拿到标记后，按照约定好的语法规则分析标记，当当前标记通过语法规则找到与之对应的标记时，那么就将该标记对应的节点输出到节点树中，如果没有找到，那么先存储起来，继续解析其他的标记，当解析到最后还没有找到符合规则的标记，那么就会报错，说明该文档的语法有误

**处理脚本和样式的顺序**
1. 脚本
当在解析文档的过程中，如果遇到脚本的话，就会停止停止解析文档，当脚本解析执行完毕后再去从上次停止的地方开始解析文档
2. 样式表
另一方面，样式表有着不同的模型。理论上来说，应用样式表不会更改 DOM 树，因此似乎没有必要等待样式表并停止文档解析。但这涉及到一个问题，就是脚本在文档解析阶段会请求样式信息。如果当时还没有加载和解析样式，脚本就会获得错误的回复，这样显然会产生很多问题。这看上去是一个非典型案例，但事实上非常普遍。Firefox 在样式表加载和解析的过程中，会禁止所有脚本。而对于 WebKit 而言，仅当脚本尝试访问的样式属性可能受尚未加载的样式表影响时，它才会禁止该脚本。
